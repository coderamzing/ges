<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talent Score & Logs - Temp Testing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .score-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .log-positive { background-color: #d4edda; }
        .log-negative { background-color: #f8d7da; }
        .log-neutral { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <a href="index.html" class="btn btn-secondary mb-3">‚Üê Back to Campaigns</a>
        <h1 class="mb-4">Talent Score & Logs</h1>

        <!-- Talent Details Display -->
        <div id="talentDetailsSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Talent Details</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> <span id="talentName">-</span></p>
                            <p><strong>Account ID:</strong> <span id="talentAccountId">-</span></p>
                            <p><strong>Talent Type:</strong> <span id="talentType">-</span></p>
                            <p><strong>City:</strong> <span id="talentCity">-</span></p>
                            <p><strong>Country:</strong> <span id="talentCountry">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Current City:</strong> <span id="talentCurrentCity">-</span></p>
                            <p><strong>Current Country:</strong> <span id="talentCurrentCountry">-</span></p>
                            <p><strong>Language Preferred:</strong> <span id="talentLangPreferred">-</span></p>
                            <p><strong>Followers:</strong> <span id="talentFollowers">-</span></p>
                            <p><strong>Rating:</strong> <span id="talentRating">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">View Talent-Promoter Data</h5>
                <form id="viewForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Talent ID</label>
                            <input type="text" class="form-control" id="talentId" placeholder="Enter Talent ID" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Promoter ID (for reference only)</label>
                            <input type="number" class="form-control" id="promoterId" placeholder="Enter Promoter ID (optional)">
                            <small class="text-muted" id="promoterIdInfo">The API uses the authenticated promoter from your login token</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">View Data</button>
                </form>
            </div>
        </div>

        <!-- Score Display -->
        <div id="scoreSection" style="display: none;">
            <div class="card mb-4 score-card">
                <div class="card-body">
                    <h5 class="card-title">Trust Score</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h2 id="trustScore">0</h2>
                                <small>Current Score</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div>
                                <strong>Last Contacted:</strong><br>
                                <span id="lastContacted">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div>
                                <strong>Last Reply:</strong><br>
                                <span id="lastReply">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div>
                                <strong>Opted Out:</strong><br>
                                <span id="optedOut">No</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Display -->
        <div id="logsSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Trust Score Logs</h5>
                    <div id="logsList">
                        <div class="text-center text-muted">Loading logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        const token = localStorage.getItem('token');

        if (!token) {
            alert('Please login first');
            window.location.href = 'index.html';
        }

        // View form submission
        $('#viewForm').on('submit', async function(e) {
            e.preventDefault();
            const talentId = $('#talentId').val().toString().trim();
            const promoterId = parseInt($('#promoterId').val());

            if (!talentId) {
                alert('Please enter Talent ID');
                return;
            }

            // Note: The API uses the authenticated promoter from the token
            // The promoterId input is for reference only
            if (promoterId) {
                $('#promoterIdInfo').text(`(Note: Using authenticated promoter from token, not ${promoterId})`);
            }

            try {
                // Load talent details
                try {
                    const talent = await $.ajax({
                        url: `${API_BASE}/talents/${talentId}`,
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    displayTalentDetails(talent);
                } catch (error) {
                    console.error('Error loading talent details:', error);
                    // Continue even if talent details fail
                }

                // Use the talent-score endpoint which requires authentication
                const data = await $.ajax({
                    url: `${API_BASE}/talents/${talentId}/score`,
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                displayScore(data.state);
                displayLogs(data.logs);
            } catch (error) {
                alert('Error loading data: ' + (error.responseJSON?.message || error.statusText));
            }
        });

        function displayTalentDetails(talent) {
            if (!talent) {
                $('#talentDetailsSection').hide();
                return;
            }

            $('#talentName').text(talent.name || '-');
            $('#talentAccountId').text(talent.accountId || '-');
            $('#talentType').text(talent.talentType || '-');
            $('#talentCity').text(talent.city || '-');
            $('#talentCountry').text(talent.country || '-');
            $('#talentCurrentCity').text(talent.currentCity || '-');
            $('#talentCurrentCountry').text(talent.currentCountry || '-');
            $('#talentLangPreferred').text(talent.langPreferred || '-');
            $('#talentFollowers').text(talent.followers || 0);
            $('#talentRating').text(talent.rating || 0);
            $('#talentDetailsSection').show();
        }

        function displayScore(state) {
            if (!state) {
                $('#trustScore').text('0');
                $('#lastContacted').text('Never');
                $('#lastReply').text('Never');
                $('#optedOut').text('No');
                $('#scoreSection').show();
                return;
            }
            $('#trustScore').text(state.trustScore || 0);
            $('#lastContacted').text(state.lastContacted ? formatDate(state.lastContacted) : 'Never');
            $('#lastReply').text(state.lastReply ? formatDate(state.lastReply) : 'Never');
            $('#optedOut').text(state.optedOut ? 'Yes' : 'No');
            $('#scoreSection').show();
        }

        function displayLogs(logs) {
            if (logs.length === 0) {
                $('#logsList').html('<div class="alert alert-info">No logs found</div>');
                $('#logsSection').show();
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr>';
            html += '<th>Date</th><th>Change</th><th>Reason</th><th>Event ID</th>';
            html += '</tr></thead><tbody>';

            logs.forEach(log => {
                const changeClass = log.change > 0 ? 'log-positive' : log.change < 0 ? 'log-negative' : 'log-neutral';
                const changeSign = log.change > 0 ? '+' : '';
                html += `<tr class="${changeClass}">`;
                html += `<td>${formatDate(log.createdAt)}</td>`;
                html += `<td><strong>${changeSign}${log.change}</strong></td>`;
                html += `<td>${escapeHtml(log.reason)}</td>`;
                html += `<td>${log.eventId || '-'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            $('#logsList').html(html);
            $('#logsSection').show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            if (!date) return '';
            return new Date(date).toLocaleString();
        }

        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const talentId = urlParams.get('talentId');
        const promoterId = urlParams.get('promoterId');
        if (talentId && promoterId) {
            $('#talentId').val(talentId);
            $('#promoterId').val(promoterId);
            $('#viewForm').submit();
        }
    </script>
</body>
</html>

